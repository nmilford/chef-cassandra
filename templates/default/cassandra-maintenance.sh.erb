#/bin/bash
# Generated by Chef for <%= @node[:fqdn] %>
logFile="/var/log/cassandra/mainenance.log"

<% @node[:cassandra][:Keyspaces].each do |ks| -%>
<%   ks[1].each do |cf| -%>
echo "<%= ks[0] %>.<%= cf %> repair started at $(date)" >> $logFile
nodetool -h <%= node[:fqdn] %> -p <%= @node[:cassandra][:JMX_PORT] %> repair <%= ks[0] %> <%= cf %>
echo "<%= ks[0] %>.<%= cf %> repair completed at $(date)" >> $logFile

# Full compactions are not necessary nor recommended anymore in Cassandra >= 1.0.
#echo "<%= ks[0] %>.<%= cf %> compaction started at $(date)" >> $logFile
#nodetool -h <%= node[:fqdn] %> -p <%= @node[:cassandra][:JMX_PORT] %> compact <%= ks[0] %> <%= cf %>
#echo "<%= ks[0] %>.<%= cf %> compaction completed at $(date)" >> $logFile

echo "<%= ks[0] %>.<%= cf %> cleanup started at $(date)" >> $logFile
nodetool -h <%= node[:fqdn] %> -p <%= @node[:cassandra][:JMX_PORT] %> cleanup <%= ks[0] %> <%= cf %>
echo "<%= ks[0] %>.<%= cf %> cleanup completed at $(date)" >> $logFile

<%   end -%>
<% end -%>
