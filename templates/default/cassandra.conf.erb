# Generated by Chef for <%= @node[:fqdn] %>

LoadPlugin java
<Plugin "java">
  JVMArg "-Djava.class.path=/usr/share/collectd/java/collectd-api.jar:/usr/share/collectd/java/generic-jmx.jar"
  LoadPlugin "org.collectd.java.GenericJMX"
  <Plugin "GenericJMX">

<% @node[:cassandra][:Keyspaces].each do |ks| -%>
<%   ks[1].each do |cf| -%>
    <MBean "<%= ks[0] %>.<%= cf %>">
      ObjectName "org.apache.cassandra.db:type=ColumnFamilies,keyspace=<%= ks[0] %>,columnfamily=<%= cf %>"
      <Value>
        Attribute "BloomFilterDiskSpaceUsed"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.BloomFilterDiskSpaceUsed"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "BloomFilterFalsePositives"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.BloomFilterFalsePositives"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "BloomFilterFalseRatio"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.BloomFilterFalseRatio"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "CompressionRatio"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.CompressionRatio"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "LiveDiskSpaceUsed"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.LiveDiskSpaceUsed"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "LiveSSTableCount"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.LiveSSTableCount"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "MaximumCompactionThreshold"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.MaximumCompactionThreshold"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "MaxRowSize"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.MaxRowSize"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "MeanRowSize"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.MeanRowSize"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "MemtableColumnsCount"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.MemtableColumnsCount"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "MemtableDataSize"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.MemtableDataSize"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "MemtableSwitchCount"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.MemtableSwitchCount"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "MinRowSize"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.MinRowSize"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "PendingTasks"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.PendingTasks"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "ReadCount"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.ReadCount"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "RecentBloomFilterFalsePositives"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.RecentBloomFilterFalsePositives"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "RecentBloomFilterFalseRatio"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.RecentBloomFilterFalseRatio"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "RecentReadLatencyMicros"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.RecentReadLatencyMicros"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "RecentWriteLatencyMicros"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.RecentWriteLatencyMicros"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "TotalDiskSpaceUsed"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.TotalDiskSpaceUsed"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "TotalReadLatencyMicros"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.TotalReadLatencyMicros"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "TotalWriteLatencyMicros"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.TotalWriteLatencyMicros"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "UnleveledSSTables"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.UnleveledSSTables"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "WriteCount"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.WriteCount"
        Type "counter"
        Table false
      </Value>
    </MBean>

    <MBean "KeyCache.<%= ks[0] %>.<%= cf %>">
      ObjectName "org.apache.cassandra.db:type=Caches,keyspace=<%= ks[0] %>,cache=<%= cf %>KeyCache"
      <Value>
        Attribute "Capacity"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.KeyCache.Capacity"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "Hits"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.KeyCache.Hits"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "RecentHitRate"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.KeyCache.RecentHitRate"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "Requests"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.KeyCache.Requests"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "Size"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.KeyCache.Size"
        Type "gauge"
        Table false
      </Value>
    </MBean>

   <MBean "RowCache.<%= ks[0] %>.<%= cf %>">
      ObjectName "org.apache.cassandra.db:type=Caches,keyspace=<%= ks[0] %>,cache=<%= cf %>RowCache"
      <Value>
        Attribute "Capacity"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.RowCache.Capacity"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "Hits"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.RowCache.Hits"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "RecentHitRate"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.RowCache.RecentHitRate"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "Requests"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.RowCache.Requests"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "Size"
        InstancePrefix "<%= ks[0] %>.<%= cf %>.RowCache.Size"
        Type "gauge"
        Table false
      </Value>
    </MBean>
<%   end -%>
<% end -%>

<% internal = [ "AntiEntropyStage",
                "FlushWriter",
                "GossipStage",
                "HintedHandoff",
                "InternalResponseStage",
                "MemtablePostFlusher",
                "MigrationStage",
                "MiscStage",
                "StreamStage" ]
   internal.each do |mbean| -%>
   <MBean "<%= mbean %>">
      ObjectName "org.apache.cassandra.internal:type=<%= mbean %>"
      <Value>
        Attribute "ActiveCount"
        InstancePrefix "<%= mbean %>.ActiveCount"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "CompletedTasks"
        InstancePrefix "<%= mbean %>.CompletedTasks"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "CurrentlyBlockedTasks"
        InstancePrefix "<%= mbean %>.CurrentlyBlockedTasks"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "PendingTasks"
        InstancePrefix "<%= mbean %>.PendingTasks"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "TotalBlockedTasks"
        InstancePrefix "<%= mbean %>.TotalBlockedTasks"
        Type "counter"
        Table false
      </Value>
    </MBean>
<% end -%>

<% request = [ "MutationStage",
               "ReadRepairStage",
               "ReadStage",
               "ReplicateOnWriteStage" ]
   request.each do |mbean| -%>
   <MBean "<%= mbean %>">
      ObjectName "org.apache.cassandra.request:type=<%= mbean %>"
      <Value>
        Attribute "ActiveCount"
        InstancePrefix "<%= mbean %>.ActiveCount"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "CompletedTasks"
        InstancePrefix "<%= mbean %>.CompletedTasks"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "CurrentlyBlockedTasks"
        InstancePrefix "<%= mbean %>.CurrentlyBlockedTasks"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "PendingTasks"
        InstancePrefix "<%= mbean %>.PendingTasks"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "TotalBlockedTasks"
        InstancePrefix "<%= mbean %>.TotalBlockedTasks"
        Type "counter"
        Table false
      </Value>
    </MBean>
<% end -%>

    <MBean "ConcurrentMarkSweep">
      ObjectName "java.lang:type=GarbageCollector,name=ConcurrentMarkSweep"
      <Value>
        Attribute "CollectionCount"
        InstancePrefix "gc.CMS.CollectionCount"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "CollectionTime"
        InstancePrefix "gc.CMS.CollectionTime"
        Type "counter"
        Table false
      </Value>
    </MBean>

    <MBean "ParNew">
      ObjectName "java.lang:type=GarbageCollector,name=ParNew"
      <Value>
        Attribute "CollectionCount"
        InstancePrefix "gc.ParNew.CollectionCount"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "CollectionTime"
        InstancePrefix "gc.ParNew.CollectionTime"
        Type "counter"
        Table false
      </Value>
    </MBean>

    <MBean "Memory">
      ObjectName "java.lang:type=Memory"
      <Value>
        Attribute "HeapMemoryUsage"
        InstancePrefix "Memory.HeapMemoryUsage-"
        Type "gauge"
        Table true
      </Value>
      <Value>
        Attribute "NonHeapMemoryUsage"
        InstancePrefix "Memory.NonHeapMemoryUsage-"
        Type "gauge"
        Table true
      </Value>
    </MBean>

    <MBean "Threading">
      ObjectName "java.lang:type=Threading"
      <Value>
        Attribute "DaemonThreadCount"
        InstancePrefix "Threading.DaemonThreadCount"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "PeakThreadCount"
        InstancePrefix "Threading.PeakThreadCount"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "ThreadCount"
        InstancePrefix "Threading.ThreadCount"
        Type "gauge"
        Table false
      </Value>
    </MBean>

    <MBean "CommitLog">
      ObjectName "org.apache.cassandra.db:type=Commitlog"
      <Value>
        Attribute "CompletedTasks"
        InstancePrefix "CommitLog.CompletedTasks"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "PendingTasks"
        InstancePrefix "CommitLog.PendingTasks"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "TotalCommitlogSize"
        InstancePrefix "CommitLog.TotalCommitlogSize"
        Type "gauge"
        Table false
      </Value>
    </MBean>

    <MBean "CompactionManager">
      ObjectName "org.apache.cassandra.db:type=CompactionManager"
      <Value>
        Attribute "Compactions"
        InstancePrefix "CompactionManager.Compactions"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "CompletedTasks"
        InstancePrefix "CompactionManager.CompletedTasks"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "PendingTasks"
        InstancePrefix "CompactionManager.PendingTasks"
        Type "gauge"
        Table false
      </Value>
    </MBean>

    <MBean "StorageService">
      ObjectName "org.apache.cassandra.db:type=StorageService"
      <Value>
        Attribute "ExceptionCount"
        InstancePrefix "StorageService.ExceptionCount"
        Type "counter"
        Table false
      </Value>
    </MBean>

    <MBean "StorageProxy">
      ObjectName "org.apache.cassandra.db:type=StorageProxy"
      <Value>
        Attribute "RangeOperations"
        InstancePrefix "StorageProxy.RangeOperations"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "ReadOperations"
        InstancePrefix "StorageProxy.ReadOperations"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "RecentRangeLatencyMicros"
        InstancePrefix "StorageProxy.RecentRangeLatencyMicros"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "RecentReadLatencyMicros"
        InstancePrefix "StorageProxy.RecentReadLatencyMicros"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "RecentWriteLatencyMicros"
        InstancePrefix "StorageProxy.RecentWriteLatencyMicros"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "TotalHints"
        InstancePrefix "StorageProxy.TotalHints"
        Type "counter"
        Table false
      </Value>
      <Value>
        Attribute "TotalRangeLatencyMicros"
        InstancePrefix "StorageProxy.TotalRangeLatencyMicros"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "TotalReadLatencyMicros"
        InstancePrefix "StorageProxy.TotalReadLatencyMicros"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "TotalWriteLatencyMicros"
        InstancePrefix "StorageProxy.TotalWriteLatencyMicros"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "WriteOperations"
        InstancePrefix "StorageProxy.WriteOperations"
        Type "counter"
        Table false
      </Value>
    </MBean>

    <MBean "MessagingService">
      ObjectName "org.apache.cassandra.net:type=MessagingService"
      <Value>
        Attribute "RecentTotalTimouts"
        InstancePrefix "MessagingService.RecentTotalTimouts"
        Type "gauge"
        Table false
      </Value>
      <Value>
        Attribute "TotalTimeouts"
        InstancePrefix "MessagingService.TotalTimeouts"
        Type "counter"
        Table false
      </Value>
    </MBean>

    <Connection>
      ServiceURL "service:jmx:rmi:///jndi/rmi://<%= @node[:fqdn] %>:<%= @node[:cassandra][:JMX_PORT] %>/jmxrmi"
      Host "<%= @node[:fqdn] %>"
<% @node[:cassandra][:Keyspaces].each do |ks| -%>
<%   ks[1].each do |cf| -%>
      Collect "<%= ks[0] %>.<%= cf %>"
      Collect "KeyCache.<%= ks[0] %>.<%= cf %>"
      Collect "RowCache.<%= ks[0] %>.<%= cf %>"
<%   end -%>
<% end -%>
<% internal.each do |mbean| -%>
      Collect "<%= mbean %>"
<% end -%>
<% request.each do |mbean| -%>
      Collect "<%= mbean %>"
<% end -%>
      Collect "ConcurrentMarkSweep"
      Collect "ParNew"
      Collect "Memory"
      Collect "Threading"
      Collect "CommitLog"
      Collect "CompactionManager"
      Collect "StorageService"
      Collect "StorageProxy"
      Collect "MessagingService"
    </Connection>
  </Plugin>
</Plugin>
